#!/bin/bash

# Current location.
cwd=$(dirname "$0")
conf="$cwd/bot.conf"
sicbin="$cwd/bin/sic"

# Grab a bunch of info from the conf file.
source "$cwd/bot.conf"

function main() {

	# Create input pipe
	if [ ! -p "$cwd/in" ] ; then
		mkfifo $cwd/in
	fi

	# Start the process, pipe output to main loop.
	$sicbin -h "$network" -p "$port" -n "$nick" <> $cwd/in |
	while read line; do
		# echo output to stdout, cuz why not?
		echo "$line"
		# Join channels after MOTD
		[ $(echo "$line" | awk '{print $5}') = "376" ] && join_channels
	done
}

function join_channels() {

	# Read from channel file and join channels
	cat $cwd/channels |
	while read line; do
		[ "${line:0:1}" = "#" ] && echo ":j $line" > $cwd/in
	done
	
	# You can remove this next if block if you like.
	# My gitignored file with testing channels in it.
	if [ -f "$cwd/.chans" ] ; then
		cat $cwd/.chans |
		while read line; do
			[ "${line:0:1}" = "#" ] && echo ":j $line" > $cwd/in
		done
	fi

}

main
