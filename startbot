#!/bin/bash

# Current location.
cwd=$(dirname "$0")
conf="$cwd/bot.conf"
sicbin="$cwd/bin/sic"
scriptmux="$cwd/bin/smux"

# Grab a bunch of info from the conf file.
source "$cwd/bot.conf"

function main() {

	# Create input pipe
	if [ ! -p "$cwd/in" ] ; then
		mkfifo $cwd/in
	fi

	# Start the process, pipe output to main loop.
	$sicbin -h "$network" -p "$port" -n "$nick" <> $cwd/in |
	while read line; do
	
		# Auto join channels after MOTD
		[ $(echo "$line" | awk '{print $5}') = "376" ] && join_channels

		# Print output to stdout. (why not?)
		echo "$line"

		# Run scripts and stuff
		$scriptmux $line

	done
}

function join_channels() {

	# Read from channel file and join channels
	cat "$cwd/channels" |
	while read line; do
		[ "${line:0:1}" = "#" ] && echo ":j $line" > $cwd/in
	done
	
	# You can remove this next if block if you like.
	# My gitignored file with testing channels in it.
	if [ -f "$cwd/.chans" ] ; then
		cat "$cwd/.chans" |
		while read line; do
			[ "${line:0:1}" = "#" ] && echo ":j $line" > $cwd/in
		done
	fi

}

function add_channel() {
	echo "$@" >> $cwd/channels
}

function rm_channel() {
	awk "/$1/ {next} {print}" $cwd/ctemp
	mv $cwd/ctemp $cwd/channels
}

main
