#!/bin/bash
set -f
unset -v IFS

# This should retrieve the location of the script in a reasonably reliable way.
[[ "$(type -ft realpath)" == "file" ]] && cwd="$(dirname "$(realpath -q "$0")")" || cwd="$(dirname $0)"

# Configuration locations
source "$cwd/conf/bot.conf"
[[ -e "$cwd/.botconf" ]] && source "$cwd/.botconf"
source ctrlbot

botstart() {

	# Create input pipe
	if [[ ! -p "$pipe/in" ]] ; then
		mkfifo "$pipe/in"
		touch "$pipe/out"
	fi

	# Start the process, pipe output to main loop.
	sic -h "$network" -p "$port" -n "$bot_nick" <> $pipe/in |
	while read line; do

		read -ra toks <<< "$line"
		echo "${toks[@]}" >> $pipe/out

		if [[ ${toks[4]} == "376" ]] ; then
			echo "Joining channels... " >> $pipe/out
			join_channels
			botsay "nickserv identify $bot_pass"
		else 
			channel="${toks[0]}"
			nick="${toks[4]//[<>]/}"
			message="${toks[@]:5}"
			[[ "$channel" == "$bot_nick" ]] && channel="$nick"
			[[ "${toks[5]}" == '!reload' ]] && bot_load
			run_scripts
		fi

	done

}

bot_load() {
	echo "Reloading ... " >> $pipe/out
	source ctrlbot
	echo "done." >> $pipe/out
}

# For internal use, or non daemon use.
if [[ "$1" == "daemon" ]] ; then
	botstart
else
	$0 "daemon"&
	exit 0
fi

